<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />

  <!-- 1) Add viewport meta for mobile scaling -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>yaproom (official)</title>
  <style>
    /* ----------------------------------------
       1) Base Styles (Light Mode by default)
       ---------------------------------------- */
    body {
      font-family: Arial, sans-serif; /* Fallback font */
      margin: 10px;
      background: #f7f7f7;
      color: #000;
      transition: background 0.3s, color 0.3s, font-family 0.3s;
    }

    /* Rounded corners for UI elements */
    #loginDiv, #chatDiv, #settingsDiv,
    #messages, #dmMessages,
    textarea, button, select {
      border-radius: 8px; 
    }

    #loginDiv, #chatDiv, #settingsDiv {
      max-width: 400px;
      margin: 0 auto;
      background: #fff;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    #chatDiv {
      display: none; /* Hidden until user enters or logs in */
    }
    #settingsDiv {
      display: none; /* Hidden until the "Settings" button is clicked */
    }

    #messages {
      list-style-type: none;
      padding: 0;
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 10px;
      border: 1px solid #ddd;
    }
    #messages li {
      padding: 8px;
      border-bottom: 1px solid #eee;
      margin: 0 4px;
    }

    /* If user is an account, color the name in blue by default; if anon, black. */
    .account-user {
      color: rgb(74, 148, 218);
      font-weight: bold;
    }
    .anonymous-user {
      color: #000;
      font-weight: normal;
    }

    /* Special style for broadcast messages. */
    .broadcast-msg {
      background: #ffeb3b;
      color: #000;
      font-weight: bold;
      padding: 4px;
      border-radius: 4px;
    }

    /* Typing status area */
    #typingStatus {
      color: #777;
      font-style: italic;
      margin-bottom: 10px;
      min-height: 18px; 
    }

    /* Chat controls use <textarea> now */
    .chat-controls {
      display: flex;
      gap: 5px;
      margin-bottom: 20px; 
    }
    textarea {
      padding: 8px;
      box-sizing: border-box;
      resize: none; /* We'll do auto-resize in JS */
      width: 100%;
      height: auto;
      min-height: 40px;
      max-height: 200px;
      overflow-y: auto;
    }
    button {
      padding: 8px;
      cursor: pointer;
    }

    .username-input,
    .enter-chat-btn {
      width: 100% !important;
      margin-top: 8px;
    }

    /* ----------------------------------------
       2) Dark Mode
       ---------------------------------------- */
    body.dark-mode {
      background: #111;
      color: #eee;
    }
    body.dark-mode #loginDiv,
    body.dark-mode #chatDiv,
    body.dark-mode #settingsDiv {
      background: #222;
      color: #eee;
    }
    body.dark-mode textarea {
      background: #333;
      color: #eee;
      border: 1px solid #444;
    }
    body.dark-mode button {
      background: #444;
      color: #eee;
      border: 1px solid #666;
    }
    body.dark-mode select {
      background: #333;
      color: #eee;
      border: 1px solid #444;
    }

    /* ----------------------------------------
       3) Custom Font Classes
       ---------------------------------------- */
    .font-arial {
      font-family: Arial, sans-serif;
    }
    .font-georgia {
      font-family: Georgia, serif;
    }
    .font-courier {
      font-family: "Courier New", Courier, monospace;
    }
    .font-comic {
      font-family: "Comic Sans MS", cursive, sans-serif;
    }
    .font-roboto {
      font-family: "Roboto", sans-serif;
    }
    .font-times {
      font-family: "Times New Roman", Times, serif;
    }
    .font-verdana {
      font-family: Verdana, sans-serif;
    }
    .font-trebuchet {
      font-family: "Trebuchet MS", Helvetica, sans-serif;
    }
    .font-lucida {
      font-family: "Lucida Sans Unicode", "Lucida Grande", sans-serif;
    }
    .font-garamond {
      font-family: Garamond, serif;
    }

    /* ----------------------------------------
       4) Message Animation
       ---------------------------------------- */
    @keyframes message-enter {
      0% {
        transform: scale(0.8);
        opacity: 0;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }
    .message-enter {
      animation: message-enter 0.3s ease forwards;
    }

    /* ----------------------------------------
       5) DM Section (Single User DM)
       ---------------------------------------- */
    #dmSection {
      margin-top: 20px;
      border-top: 1px solid #ccc;
      padding-top: 10px;
    }
    #dmMessages {
      list-style-type: none;
      padding: 0;
      max-height: 200px;
      overflow-y: auto;
      margin-bottom: 10px;
      border: 1px solid #ddd;
    }
    #dmMessages li {
      padding: 8px;
      border-bottom: 1px solid #eee;
      margin: 0 4px;
    }
    .dm-controls {
      display: flex;
      gap: 5px;
    }

    /* ----------------------------------------
       Tutorial box styling
       ---------------------------------------- */
    .tutorial-box {
      margin-bottom:10px; 
      font-size: 0.9em; 
      background:#fafafa; 
      padding:6px; 
      border-radius:5px;
      transition: background 0.3s, color 0.3s;
    }
    body.dark-mode .tutorial-box {
      background: #333;
      color: #eee;
    }

    /* ----------------------------------------
       7) Changelog Overlay
       (Always shows on page load)
       ---------------------------------------- */
    #changelogOverlay {
      position: fixed;
      top: 0; 
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      display: none; 
      justify-content: center;
      align-items: center;
      z-index: 9999; 
    }
    #changelogModal {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      max-width: 400px;
      width: 90%;
      color: #000;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    #changelogModal h2 {
      margin-top: 0;
    }
    #changelogModal ul {
      margin: 10px 0;
      padding-left: 20px;
    }
    #changelogModal button {
      margin-top: 10px;
    }

  </style>
</head>
<body>

  <!-- ===============================
       CHANGELOG POPUP (ALWAYS SHOWS)
       =============================== -->
  <div id="changelogOverlay">
    <div id="changelogModal">
      <h2>Changelog (v1.1.7)</h2>
      <ul>
        <li>UI auto-scales to fit phone/tablet/desktop by default.</li>
        <li>User can still override with the GUI Size slider.</li>
      </ul>
      <button onclick="closeChangelog()">Close</button>
    </div>
  </div>

  <!-- ===============================
       1) LOGIN SCREEN (loginDiv)
       =============================== -->
  <div id="loginDiv">
    <h2>Enter Chat</h2>
    <p>Anonymous / Temporary Name:</p>
    <input type="text" id="anonymousInput" class="username-input" placeholder="Anonymous Name" />
    <button onclick="startChatting()" class="enter-chat-btn">Start Chatting</button>

    <hr />
    <!-- Account Management (Username + Password) -->
    <h3>Account</h3>
    <div id="notLoggedInUI">
      <input type="text" id="accNameInput" placeholder="Desired username" style="width:100%; margin-bottom:5px;" />
      <input type="text" id="accPassInput" placeholder="Password" style="width:100%; margin-bottom:5px;" />
      <button onclick="createOrLoginAccount()">Create/Login Account</button>
    </div>

    <div id="loggedInUI" style="display:none;">
      <p>Logged in as: <span id="loggedInName"></span></p>

      <!-- Rename Account -->
      <input type="text" id="renameInput" placeholder="New username" style="width:100%; margin-bottom:5px;" />
      <button onclick="renameAccount()">Rename Account</button>
      <br /><br />

      <!-- Change Password -->
      <input type="text" id="changePassInput" placeholder="New Password" style="width:100%; margin-bottom:5px;" />
      <button onclick="changePassword()">Change Password</button>
      <br /><br />

      <button onclick="logOutAccount()">Log Out</button>
    </div>

    <hr />
    <!-- Settings button is only here, in the main screen -->
    <button onclick="showSettingsFromLogin()">Settings</button>

    <!-- ===============================
         OP-ONLY SECTION (MAIN MENU BOTTOM)
         =============================== -->
    <div id="opSection" style="display:none; margin-top: 20px; border-top:1px solid #ccc; padding-top:10px;">
      <h3>OP Tools</h3>
      <!-- Clear Chat Button -->
      <button onclick="clearChatForEveryone()" style="background:#e00; color:#fff;">Clear Chat (Server-Side)</button>
      <br /><br />

      <!-- Broadcast -->
      <label for="opBroadcastInput">Broadcast Message (shown to all):</label><br/>
      <input type="text" id="opBroadcastInput" style="width:100%; margin-bottom:5px;" />
      <button onclick="sendBroadcast()" style="background:#2196F3; color:#fff;">Send Broadcast</button>
      <br /><br />

      <!-- Color Picker (Optional) -->
      <label for="opColorPicker">Change Your Name Color:</label><br/>
      <input type="color" id="opColorPicker" value="#4A94DA" />
      <button onclick="setOpColor()">Set Name Color</button>
    </div>
  </div>

  <!-- ================================
       2) CHAT SCREEN (chatDiv)
       ================================ -->
  <div id="chatDiv">
    <h2>Yap Room</h2>

    <!-- Quick list of room commands -->
    <div class="tutorial-box">
      <strong>Group Chat Commands:</strong><br/>
      /createroom [roomName]<br/>
      /join [roomName]<br/>
      /invite [accountName]<br/>
      /leave
    </div>

    <!-- A) Messages + "Who is typing" indicator -->
    <ul id="messages"></ul>
    <div id="typingStatus"></div>

    <div class="chat-controls">
      <textarea id="messageInput" placeholder="Type a message" oninput="handleTyping()"></textarea>
      <button onclick="sendMessage()">Send</button>
      <button onclick="clearChat()">Clear Chat</button>
    </div>

    <!-- 2B) Direct Messages Section (Single DM) -->
    <div id="dmSection">
      <h3>Direct Messages</h3>
      <div id="dmLoginWarning" style="color:red; display:none;">
        You must be logged in to use DMs.
      </div>
      <div id="dmUI" style="display:none;">
        <p>Type a single username to DM:</p>
        <input type="text" id="dmTargetInput" placeholder="username to DM" style="width:100%; margin-bottom:5px;" />
        <button onclick="openDM()">Open DM</button>

        <div id="dmConversation" style="margin-top:10px; display:none;">
          <ul id="dmMessages"></ul>
          <div class="dm-controls">
            <textarea id="dmMessageInput" placeholder="Type a direct message" oninput="handleTyping()"></textarea>
            <button onclick="sendDM()">Send DM</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 2C) Return to Main Screen -->
    <div style="margin-top:20px; text-align:center;">
      <button onclick="returnToLogin()">Return to Main Screen</button>
    </div>
  </div>

  <!-- ================================
       3) SETTINGS SCREEN (settingsDiv)
       ================================ -->
  <div id="settingsDiv">
    <h2>Settings</h2>
    <label>
      <input type="checkbox" id="themeToggle" onchange="toggleDarkMode()" />
      Dark Mode
    </label>
    <br><br>

    <label for="guiSizeRange">GUI Size</label>
    <input type="range" id="guiSizeRange" min="0.5" max="2.0" step="0.1" value="1.0" onchange="updateGuiSize()" />
    <p id="guiSizeValue"></p>

    <label for="fontSelect">Choose Font:</label>
    <select id="fontSelect" onchange="updateFont()">
      <option value="font-arial">Arial</option>
      <option value="font-georgia">Georgia</option>
      <option value="font-courier">Courier New</option>
      <option value="font-comic">Comic Sans MS</option>
      <option value="font-roboto">Roboto</option>
      <option value="font-times">Times New Roman</option>
      <option value="font-verdana">Verdana</option>
      <option value="font-trebuchet">Trebuchet MS</option>
      <option value="font-lucida">Lucida Sans Unicode</option>
      <option value="font-garamond">Garamond</option>
    </select>
    <br><br>

    <!-- Notification toggle -->
    <label>
      <input type="checkbox" id="notificationsToggle" onchange="toggleNotifications()" />
      Enable Desktop Notifications
    </label>
    <br><br>

    <button onclick="goBack()">Back</button>
  </div>

  <!-- ---------------------------------
       Firebase SDK (Compat versions)
       --------------------------------->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>

  <!-- SHA-256 library for hashing passwords -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>

  <script>
    /* =====================================================
       1) Firebase Configuration & Initialization
       (DO NOT CHANGE THESE KEYS)
       ===================================================== */
    const firebaseConfig = {
      apiKey: "AIzaSyBkm5Lf3PaghllqcatG_FymhTm_x7mGa28",
      authDomain: "yaproom-14cfe.firebaseapp.com",
      databaseURL: "https://yaproom-14cfe-default-rtdb.firebaseio.com",
      projectId: "yaproom-14cfe",
      storageBucket: "yaproom-14cfe.firebasestorage.app",
      messagingSenderId: "5332542311",
      appId: "1:5332542311:web:f1a1ab2fb81bf62b0b45c2"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    /* =====================================================
       2) Global Variables & OP List
       ===================================================== */
    // Add more OP usernames here if needed
    const OP_LIST = ["god", "pasta"]; 

    let lastMessageTime = 0;
    const RATE_LIMIT_MS = 2000; // 2-second limit
    const badWords = ["shit","fuck","bitch", "nigga", "fucking", "shitting", "negro", "bullshit", "pussy"]; // Expand as needed

    let currentUsername = null;
    let currentPassHash = null;

    // DM
    let currentDMPath = null;
    let dmListener = null;

    // Group Chat 
    let inGroupChat = false;
    let currentGroupRoomName = null;
    let groupListener = null;

    // Typing
    let typingTimeout = null;

    // Mute system
    let mutedUsers = {};

    // OP color system
    let accountColors = {};

    // Track if user changed GUI scale manually
    let userOverrodeScale = false;

    /* =====================================================
       3) On Page Load: Always show Changelog
       ===================================================== */
    window.onload = function() {
      // Always show the overlay on every refresh or new tab
      document.getElementById("changelogOverlay").style.display = "flex";

      // A) Auto-scale for device (only if user hasn't set a custom scale)
      // We'll call autoScaleUI() first. Then if there's a localStorage scale, that overrides it.
      autoScaleUI();

      // B) Dark Mode
      const darkModeEnabled = localStorage.getItem("darkModeEnabled") === "true";
      if (darkModeEnabled) document.body.classList.add("dark-mode");
      document.getElementById("themeToggle").checked = darkModeEnabled;

      // C) GUI Size from localStorage
      const savedScale = localStorage.getItem("uiScale");
      if (savedScale) {
        userOverrodeScale = true; // user previously set a custom scale
        document.documentElement.style.fontSize = (16 * savedScale) + "px";
        document.getElementById("guiSizeRange").value = savedScale;
      }
      updateGuiSizeDisplay();

      // D) Font
      const savedFont = localStorage.getItem("selectedFont") || "font-arial";
      document.body.classList.add(savedFont);
      document.getElementById("fontSelect").value = savedFont;

      // E) Account
      currentUsername = localStorage.getItem("acc_username");
      currentPassHash = localStorage.getItem("acc_passHash");
      updateAccountUI();

      // F) Listen for public chat (child_added + child_removed)
      db.ref("messages").on("child_added", (snapshot) => {
        const msg = snapshot.val();
        // If user is muted, skip
        if (msg.user && mutedUsers[msg.user.toLowerCase()]) return;
        displayMessage(msg.user, msg.text, msg.isAccount, false, snapshot.key);
      });
      db.ref("messages").on("child_removed", (snap) => {
        const removedKey = snap.key;
        const li = document.querySelector(`li[data-key="${removedKey}"]`);
        if (li) li.remove();
      });

      // G) Listen for "typing" updates
      db.ref("typing").on("value", (snap) => {
        const typingObj = snap.val() || {};
        showTypingStatus(typingObj);
      });

      // H) Listen for muted users
      db.ref("mutedUsers").on("value", (snap) => {
        mutedUsers = snap.val() || {};
      });

      // I) Listen for account colors
      db.ref("accountColors").on("value", (snap) => {
        accountColors = snap.val() || {};
      });

      // J) Listen for OP broadcasts (child_added + child_removed)
      db.ref("broadcasts").on("child_added", (snap) => {
        const bData = snap.val();
        displayMessage(bData.user, bData.text, true, true, snap.key); 
      });
      db.ref("broadcasts").on("child_removed", (snap) => {
        const removedKey = snap.key;
        const li = document.querySelector(`li[data-key="${removedKey}"]`);
        if (li) li.remove();
      });

      // SHIFT+ENTER for main chat
      const msgInput = document.getElementById("messageInput");
      msgInput.addEventListener("keydown", function(e) {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
      msgInput.addEventListener("input", autoResize);

      // SHIFT+ENTER for DM
      const dmInput = document.getElementById("dmMessageInput");
      dmInput.addEventListener("keydown", function(e) {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendDM();
        }
      });
      dmInput.addEventListener("input", autoResize);

      // K) Restore Notifications Setting
      const notificationsEnabled = localStorage.getItem("notificationsEnabled") === "true";
      const notificationsToggle = document.getElementById("notificationsToggle");
      if (notificationsToggle) {
        notificationsToggle.checked = notificationsEnabled;
      }

      // L) Listen for window resize to auto-scale if user hasn't overridden
      window.addEventListener("resize", function() {
        if (!userOverrodeScale) {
          autoScaleUI();
        }
      });
    };

    /* Close the changelog overlay each time */
    function closeChangelog() {
      document.getElementById("changelogOverlay").style.display = "none";
    }

    /* =====================================================
       Auto-Scale the UI Based on Screen Size
       ===================================================== */
    function autoScaleUI() {
      // Example breakpoints, adjust as you prefer
      const width = window.innerWidth;

      let scale = 1.0;
      if (width < 480) {
        // phone
        scale = 0.8;
      } else if (width < 768) {
        // small tablet
        scale = 0.9;
      } else {
        // bigger screens
        scale = 1.0;
      }

      document.documentElement.style.fontSize = (16 * scale) + "px";
      document.getElementById("guiSizeRange").value = scale;
      localStorage.setItem("uiScale", scale);
      updateGuiSizeDisplay();
    }

    /* Auto-resize logic for textareas */
    function autoResize(event) {
      const textarea = event.target;
      textarea.style.height = "auto";
      textarea.style.height = (textarea.scrollHeight) + "px";
    }

    /* =====================================================
       4) Account Creation / Login
       ===================================================== */
    async function createOrLoginAccount() {
      const desiredName = document.getElementById("accNameInput").value.trim().toLowerCase();
      const desiredPass = document.getElementById("accPassInput").value.trim();
      if (!desiredName || !desiredPass) {
        alert("Please provide both a username and a password.");
        return;
      }
      const passHash = sha256(desiredPass);

      try {
        const snap = await db.ref("accounts/" + desiredName).once("value");
        if (!snap.exists()) {
          // Create new account
          await db.ref("accounts/" + desiredName).set({
            passwordHash: passHash,
            createdAt: Date.now()
          });
          alert("Account created! Logged in as: " + desiredName);
        } else {
          // Existing account, verify password
          const data = snap.val();
          if (data.passwordHash !== passHash) {
            alert("Incorrect password or name is taken by someone else.");
            return;
          }
          alert("Logged in successfully as: " + desiredName);
        }
        currentUsername = desiredName;
        currentPassHash = passHash;
        localStorage.setItem("acc_username", currentUsername);
        localStorage.setItem("acc_passHash", currentPassHash);
        updateAccountUI();
      } catch (err) {
        alert("Error creating/logging in: " + err);
      }
    }

    function updateAccountUI() {
      const notLoggedInUI = document.getElementById("notLoggedInUI");
      const loggedInUI = document.getElementById("loggedInUI");
      const loggedInName = document.getElementById("loggedInName");
      const anonInput = document.getElementById("anonymousInput");

      if (currentUsername && currentPassHash) {
        // Logged in
        notLoggedInUI.style.display = "none";
        loggedInUI.style.display = "block";
        loggedInName.textContent = currentUsername;

        // Make the "anonymous name" box read-only, showing the current username
        anonInput.value = currentUsername;
        anonInput.disabled = true;
      } else {
        // Not logged in
        notLoggedInUI.style.display = "block";
        loggedInUI.style.display = "none";

        // Reset the anonymous input
        anonInput.value = "";
        anonInput.disabled = false;
      }
      updateDMUI();
      checkIfOP();
    }

    async function logOutAccount() {
      if (currentUsername) {
        db.ref("typing/" + currentUsername).remove();
      }
      localStorage.removeItem("acc_username");
      localStorage.removeItem("acc_passHash");
      currentUsername = null;
      currentPassHash = null;
      alert("Logged out.");
      updateAccountUI();
    }

    /* =====================================================
       5) Rename Account
       ===================================================== */
    async function renameAccount() {
      if (!currentUsername || !currentPassHash) {
        alert("You are not logged in, can't rename.");
        return;
      }
      const newName = document.getElementById("renameInput").value.trim().toLowerCase();
      if (!newName) {
        alert("Enter a new username.");
        return;
      }
      // Check if taken
      const snap = await db.ref("accounts/" + newName).once("value");
      if (snap.exists()) {
        alert("That username is taken.");
        return;
      }
      try {
        // remove old
        await db.ref("accounts/" + currentUsername).remove();
        // create new
        await db.ref("accounts/" + newName).set({
          passwordHash: currentPassHash,
          createdAt: Date.now()
        });
        // remove old typing
        db.ref("typing/" + currentUsername).remove();

        currentUsername = newName;
        localStorage.setItem("acc_username", currentUsername);
        alert("Renamed to " + newName);
        updateAccountUI();
      } catch (err) {
        alert("Error renaming: " + err);
      }
    }

    /* =====================================================
       5B) Change Password
       ===================================================== */
    async function changePassword() {
      if (!currentUsername || !currentPassHash) {
        alert("You are not logged in, can't change password.");
        return;
      }
      const newPass = document.getElementById("changePassInput").value.trim();
      if (!newPass) {
        alert("Enter a new password.");
        return;
      }
      const newPassHash = sha256(newPass);

      try {
        await db.ref("accounts/" + currentUsername).update({
          passwordHash: newPassHash
        });
        currentPassHash = newPassHash;
        localStorage.setItem("acc_passHash", newPassHash);
        alert("Password changed successfully!");
        document.getElementById("changePassInput").value = "";
      } catch (err) {
        alert("Error changing password: " + err);
      }
    }

    /* =====================================================
       6) Starting the Chat
       ===================================================== */
    function startChatting() {
      if (!currentUsername) {
        const anonName = document.getElementById("anonymousInput").value.trim();
        if (!anonName) {
          alert("Please enter a name or create an account.");
          return;
        }
        currentUsername = anonName;
      }
      document.getElementById("loginDiv").style.display = "none";
      document.getElementById("chatDiv").style.display = "block";
      updateDMUI();
    }

    /* =====================================================
       7) Public Chat
       ===================================================== */
    function filterBadWords(text) {
      const badWordsLower = badWords.map(word => word.toLowerCase());
      let filtered = text;
      badWordsLower.forEach(word => {
        const regex = new RegExp("\\b" + word + "\\b", "gi");
        filtered = filtered.replace(regex, "****");
      });
      return filtered;
    }

    function sendMessage() {
      const inp = document.getElementById("messageInput");
      let text = inp.value.trim();
      if (!text) return;

      if (text.startsWith("/")) {
        handleSlashCommand(text);
        inp.value = "";
        inp.style.height = "40px";
        return;
      }

      // Rate limit
      const currentTime = Date.now();
      if (currentTime - lastMessageTime < RATE_LIMIT_MS) {
        const secLeft = Math.ceil((RATE_LIMIT_MS - (currentTime - lastMessageTime)) / 1000);
        alert(`Wait ${secLeft} second(s).`);
        return;
      }

      // Mute check
      if (currentUsername && mutedUsers[currentUsername.toLowerCase()]) {
        alert("You are muted and cannot send messages.");
        inp.value = "";
        inp.style.height = "40px";
        return;
      }

      text = filterBadWords(text);

      let finalName = currentUsername || "Unknown";
      const isAccount = (currentUsername && currentPassHash);

      // Are we in a group chat?
      if (inGroupChat && currentGroupRoomName) {
        db.ref("groupRooms/" + currentGroupRoomName + "/messages").push({
          user: finalName,
          text: text,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        });
      } else {
        db.ref("messages").push({
          user: finalName,
          text: text,
          isAccount: isAccount,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        });
      }

      inp.value = "";
      inp.style.height = "40px";
      lastMessageTime = currentTime;

      if (currentUsername) {
        db.ref("typing/" + currentUsername).remove();
      }
    }

    function displayMessage(user, text, isAccount, isBroadcast, messageKey) {
      const ul = document.getElementById("messages");
      const li = document.createElement("li");
      li.classList.add("message-enter");

      if (messageKey) {
        li.setAttribute("data-key", messageKey);
      }

      let userColorClass = isAccount ? "account-user" : "anonymous-user";
      let colorStyle = "";

      if (accountColors[user?.toLowerCase()]) {
        colorStyle = `style="color:${accountColors[user.toLowerCase()]}; font-weight:bold;"`;
      } else if (isAccount) {
        // default for account is a blue color
        colorStyle = `style="color:rgb(74, 148, 218);"`;
      }

      if (isBroadcast) {
        li.innerHTML = `<span class="broadcast-msg">[BROADCAST from ${user}]</span> ${text}`;
      } else {
        li.innerHTML = `<span class="${userColorClass}" ${colorStyle}>${user}</span>: ${text}`;
      }

      ul.appendChild(li);
      ul.scrollTop = ul.scrollHeight;
    }

    function clearChat() {
      const confirmClear = confirm("Are you sure you want to clear the chat messages **on your screen**?");
      if (!confirmClear) return;
      document.getElementById("messages").innerHTML = "";
    }

    /* =====================================================
       8) Typing Indicators (Main Chat)
       ===================================================== */
    function handleTyping() {
      if (!currentUsername) return;
      db.ref("typing/" + currentUsername).set(true);
      if (typingTimeout) clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        db.ref("typing/" + currentUsername).remove();
      }, 3000);
    }

    function showTypingStatus(typingObj) {
      const keys = Object.keys(typingObj).filter((u) => u !== currentUsername);
      const typingDiv = document.getElementById("typingStatus");
      if (keys.length === 0) {
        typingDiv.textContent = "";
      } else if (keys.length === 1) {
        typingDiv.textContent = `${keys[0]} is typing...`;
      } else {
        typingDiv.textContent = `${keys.join(", ")} are typing...`;
      }
    }

    /* =====================================================
       9) Single DM
       ===================================================== */
    function updateDMUI() {
      const warn = document.getElementById("dmLoginWarning");
      const ui = document.getElementById("dmUI");
      if (currentUsername && currentPassHash) {
        warn.style.display = "none";
        ui.style.display = "block";
      } else {
        warn.style.display = "block";
        ui.style.display = "none";
      }
    }

    // Avoid duplicate DM messages by removing old listener before creating new
    function openDM() {
      const typedName = document.getElementById("dmTargetInput").value.trim().toLowerCase();
      if (!typedName) {
        alert("Please type a username to DM.");
        return;
      }
      if (!currentUsername || !currentPassHash) {
        alert("You must be logged in to DM.");
        return;
      }

      // Remove old listener
      if (dmListener && currentDMPath) {
        db.ref(currentDMPath).off("child_added", dmListener);
      }

      const userA = currentUsername.toLowerCase();
      const userB = typedName;
      const dmKey = (userA < userB) ? (userA + "_" + userB) : (userB + "_" + userA);
      currentDMPath = "dms/" + dmKey;

      document.getElementById("dmMessages").innerHTML = "";
      document.getElementById("dmConversation").style.display = "block";

      dmListener = db.ref(currentDMPath).on("child_added", (snap) => {
        const val = snap.val();
        displayDMMessage(val.user, val.text);

        if (val.user !== currentUsername) {
          showDMNotification(val.user, val.text);
        }
      });
    }

    function displayDMMessage(sender, text) {
      const ul = document.getElementById("dmMessages");
      const li = document.createElement("li");
      li.textContent = `${sender}: ${text}`;
      li.classList.add("message-enter");
      ul.appendChild(li);
      ul.scrollTop = ul.scrollHeight;
    }

    function sendDM() {
      if (!currentDMPath) {
        alert("No DM open. Type a username and 'Open DM' first.");
        return;
      }
      const inp = document.getElementById("dmMessageInput");
      let text = inp.value.trim();
      if (!text) return;

      text = filterBadWords(text);

      if (currentUsername && mutedUsers[currentUsername.toLowerCase()]) {
        alert("You are muted and cannot send messages.");
        inp.value = "";
        inp.style.height = "40px";
        return;
      }

      const finalName = currentUsername || "Unknown";
      db.ref(currentDMPath).push({
        user: finalName,
        text: text,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      });
      inp.value = "";
      inp.style.height = "40px"; 
    }

    /* =====================================================
       10) Group Chat (Revamped with Slash Commands)
       ===================================================== */
    async function handleSlashCommand(text) {
      const parts = text.split(" ");
      const cmd = parts[0].toLowerCase(); 
      const arg = parts[1] ? parts[1].trim().toLowerCase() : null;

      // If user is OP, check OP commands first (/mute, /unmute)
      if (isCurrentUserOP() && (cmd === "/mute" || cmd === "/unmute")) {
        handleOpCommand(cmd, arg);
        return;
      }

      switch(cmd) {
        case "/createroom":
          if (!arg) {
            alert("Usage: /createroom [roomName]");
            return;
          }
          await createGroupRoom(arg);
          break;

        case "/join":
          if (!arg) {
            alert("Usage: /join [roomName]");
            return;
          }
          await joinGroupRoom(arg);
          break;

        case "/invite":
          if (!arg) {
            alert("Usage: /invite [accountName]");
            return;
          }
          await inviteToGroup(arg);
          break;

        case "/leave":
          leaveGroupRoom();
          break;

        default:
          alert("Unknown command.");
      }
    }

    async function createGroupRoom(roomName) {
      if (!currentUsername || !currentPassHash) {
        alert("You must be logged in to create a group room.");
        return;
      }
      const snap = await db.ref("groupRooms/" + roomName).once("value");
      if (snap.exists()) {
        alert("That room name already exists. Choose a different one.");
        return;
      }
      await db.ref("groupRooms/" + roomName).set({
        participants: [currentUsername.toLowerCase()],
        createdAt: Date.now(),
        messages: {
          dummy: { system: "Group created" }
        }
      });
      alert(`Group room "${roomName}" created. You are now inside it.`);
      joinGroupRoom(roomName);
    }

    async function joinGroupRoom(roomName) {
      if (!currentUsername || !currentPassHash) {
        alert("You must be logged in to join a group room.");
        return;
      }
      const snap = await db.ref("groupRooms/" + roomName).once("value");
      if (!snap.exists()) {
        alert("That room does not exist.");
        return;
      }
      const roomData = snap.val();
      const me = currentUsername.toLowerCase();
      if (!roomData.participants || !roomData.participants.includes(me)) {
        alert("You are not invited to this room. Ask someone to /invite you.");
        return;
      }

      inGroupChat = true;
      currentGroupRoomName = roomName;

      if (groupListener) {
        db.ref("groupRooms/" + roomName + "/messages").off("child_added", groupListener);
      }
      document.getElementById("messages").innerHTML = "";
      groupListener = db.ref("groupRooms/" + roomName + "/messages").on("child_added", (snapMsg) => {
        const val = snapMsg.val();
        if (val.user && val.text) {
          if (mutedUsers[val.user.toLowerCase()]) return;
          displayMessage(val.user, val.text, true, false);
        } else if (val.system) {
          displayMessage("System", val.system, false, false);
        }
      });

      alert(`You joined group room "${roomName}". All your messages will now go there.`);
    }

    async function inviteToGroup(accountName) {
      if (!inGroupChat || !currentGroupRoomName) {
        alert("You are not in a group room. Use /join [roomName] first.");
        return;
      }
      const roomRef = db.ref("groupRooms/" + currentGroupRoomName + "/participants");
      const snap = await roomRef.once("value");
      const participants = snap.val() || [];
      if (!participants.includes(accountName)) {
        participants.push(accountName);
      }
      await roomRef.set(participants);
      db.ref("groupRooms/" + currentGroupRoomName + "/messages").push({
        system: `${accountName} has been invited.`
      });
      alert(`${accountName} invited to "${currentGroupRoomName}".`);
    }

    function leaveGroupRoom() {
      if (!inGroupChat) {
        alert("You are not in a group room.");
        return;
      }
      if (groupListener) {
        db.ref("groupRooms/" + currentGroupRoomName + "/messages").off("child_added", groupListener);
      }
      inGroupChat = false;
      currentGroupRoomName = null;
      document.getElementById("messages").innerHTML = "";
      alert("You left the group room. You are back to public chat.");
    }

    /* =====================================================
       11) OP Commands & Tools
       ===================================================== */
    function isCurrentUserOP() {
      return currentUsername && OP_LIST.includes(currentUsername.toLowerCase());
    }

    function checkIfOP() {
      const opSection = document.getElementById("opSection");
      if (isCurrentUserOP()) {
        opSection.style.display = "block";
      } else {
        opSection.style.display = "none";
      }
    }

    function handleOpCommand(cmd, target) {
      if (!target) {
        alert("Usage: " + cmd + " [username]");
        return;
      }
      if (cmd === "/mute") {
        db.ref("mutedUsers/" + target).set(true);
        alert(`User "${target}" has been muted.`);
      } else if (cmd === "/unmute") {
        db.ref("mutedUsers/" + target).remove();
        alert(`User "${target}" has been unmuted.`);
      }
    }

    function clearChatForEveryone() {
      const confirmClear = confirm("Are you sure you want to clear the entire public chat AND all broadcasts for EVERYONE?");
      if (!confirmClear) return;
      db.ref("messages").remove();
      db.ref("broadcasts").remove();
      document.getElementById("messages").innerHTML = "";
      alert("All messages and broadcasts cleared for everyone.");
    }

    function sendBroadcast() {
      if (!isCurrentUserOP()) {
        alert("You are not an OP!");
        return;
      }
      const broadcastInput = document.getElementById("opBroadcastInput");
      const text = broadcastInput.value.trim();
      if (!text) return;
      db.ref("broadcasts").push({
        user: currentUsername,
        text: text,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      });
      broadcastInput.value = "";
      alert("Broadcast sent!");
    }

    function setOpColor() {
      if (!isCurrentUserOP()) {
        alert("You are not an OP!");
        return;
      }
      const colorPicker = document.getElementById("opColorPicker");
      const chosenColor = colorPicker.value;
      db.ref("accountColors/" + currentUsername.toLowerCase()).set(chosenColor);
      alert("Your chat color has been updated to: " + chosenColor);
    }

    /* =====================================================
       12) Return to Main Screen
       ===================================================== */
    function returnToLogin() {
      document.getElementById("chatDiv").style.display = "none";
      document.getElementById("loginDiv").style.display = "block";
      checkIfOP();
    }

    /* =====================================================
       13) Settings Navigation
       ===================================================== */
    function showSettingsFromLogin() {
      document.getElementById("loginDiv").style.display = "none";
      document.getElementById("settingsDiv").style.display = "block";
    }

    function goBack() {
      document.getElementById("settingsDiv").style.display = "none";
      document.getElementById("loginDiv").style.display = "block";
    }

    /* =====================================================
       14) Dark Mode Toggle
       ===================================================== */
    function toggleDarkMode() {
      document.body.classList.toggle("dark-mode");
      const isDark = document.body.classList.contains("dark-mode");
      localStorage.setItem("darkModeEnabled", isDark);
    }

    /* =====================================================
       15) GUI Size
       ===================================================== */
    function updateGuiSize() {
      userOverrodeScale = true; // user is overriding the auto-scale
      const scale = document.getElementById("guiSizeRange").value;
      document.documentElement.style.fontSize = (16 * scale) + "px";
      localStorage.setItem("uiScale", scale);
      updateGuiSizeDisplay();
    }

    function updateGuiSizeDisplay() {
      const val = document.getElementById("guiSizeRange").value;
      document.getElementById("guiSizeValue").textContent = `Current Scale: ${val}x`;
    }

    /* =====================================================
       16) Custom Font
       ===================================================== */
    function updateFont() {
      document.body.classList.remove(
        "font-arial",
        "font-georgia",
        "font-courier",
        "font-comic",
        "font-roboto",
        "font-times",
        "font-verdana",
        "font-trebuchet",
        "font-lucida",
        "font-garamond"
      );
      const selectedFont = document.getElementById("fontSelect").value;
      document.body.classList.add(selectedFont);
      localStorage.setItem("selectedFont", selectedFont);
    }

    /* =====================================================
       17) Desktop Notifications
       ===================================================== */
    function toggleNotifications() {
      const isChecked = document.getElementById("notificationsToggle").checked;
      localStorage.setItem("notificationsEnabled", isChecked);

      if (isChecked) {
        requestNotificationPermission();
      }
    }

    function requestNotificationPermission() {
      if (!("Notification" in window)) {
        alert("This browser does not support desktop notifications.");
        return;
      }
      if (Notification.permission !== "granted") {
        Notification.requestPermission().then((permission) => {
          if (permission !== "granted") {
            alert("You blocked notifications in your browser settings.");
            document.getElementById("notificationsToggle").checked = false;
            localStorage.setItem("notificationsEnabled", false);
          }
        });
      }
    }

    function showDMNotification(user, text) {
      const isNotificationsEnabled = localStorage.getItem("notificationsEnabled") === "true";
      if (!("Notification" in window) || !isNotificationsEnabled) return;

      // Only show if document is not in focus
      if (document.hidden && Notification.permission === "granted") {
        new Notification("New DM from " + user, {
          body: text,
          icon: "https://via.placeholder.com/50" // optional icon
        });
      }
    }
  </script>
</body>
</html>
