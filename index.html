<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>yaproom (official)</title>
  <style>
    /* ----------------------------------------
       1) Base Styles (Light Mode by default)
       ---------------------------------------- */
    body {
      font-family: Arial, sans-serif; /* Fallback font */
      margin: 10px;
      background: #f7f7f7;
      color: #000;
      transition: background 0.3s, color 0.3s, font-family 0.3s;
    }

    /* Rounded corners for UI elements */
    #loginDiv, #chatDiv, #settingsDiv,
    #messages, #dmMessages, #groupDMMessages,
    textarea, button, select {
      border-radius: 8px; 
    }

    #loginDiv, #chatDiv, #settingsDiv {
      max-width: 400px;
      margin: 0 auto;
      background: #fff;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    #chatDiv {
      display: none; /* Hidden until user enters or logs in */
    }
    #settingsDiv {
      display: none; /* Hidden until the "Settings" button is clicked */
    }

    #messages {
      list-style-type: none;
      padding: 0;
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 10px;
      border: 1px solid #ddd;
    }
    #messages li {
      padding: 8px;
      border-bottom: 1px solid #eee;
      margin: 0 4px;
    }

    /* If user is an account, color the name in blue; if anon, black. */
    .account-user {
      color: rgb(74, 148, 218);
      font-weight: bold;
    }
    .anonymous-user {
      color: #000;
      font-weight: normal;
    }

    /* Typing status area */
    #typingStatus {
      color: #777;
      font-style: italic;
      margin-bottom: 10px;
      min-height: 18px; 
    }

    /* Chat controls use <textarea> now */
    .chat-controls {
      display: flex;
      gap: 5px;
      margin-bottom: 20px; 
    }
    textarea {
      padding: 8px;
      box-sizing: border-box;
      resize: none; /* We'll do auto-resize in JS */
      width: 100%;
      height: auto;
      min-height: 40px;
      max-height: 200px;
      overflow-y: auto;
    }
    button {
      padding: 8px;
      cursor: pointer;
    }

    .username-input,
    .enter-chat-btn {
      width: 100% !important;
      margin-top: 8px;
    }

    /* ----------------------------------------
       2) Dark Mode
       ---------------------------------------- */
    body.dark-mode {
      background: #111;
      color: #eee;
    }
    body.dark-mode #loginDiv,
    body.dark-mode #chatDiv,
    body.dark-mode #settingsDiv {
      background: #222;
      color: #eee;
    }
    body.dark-mode textarea {
      background: #333;
      color: #eee;
      border: 1px solid #444;
    }
    body.dark-mode button {
      background: #444;
      color: #eee;
      border: 1px solid #666;
    }
    body.dark-mode select {
      background: #333;
      color: #eee;
      border: 1px solid #444;
    }

    /* ----------------------------------------
       3) Custom Font Classes
       ---------------------------------------- */
    .font-arial {
      font-family: Arial, sans-serif;
    }
    .font-georgia {
      font-family: Georgia, serif;
    }
    .font-courier {
      font-family: "Courier New", Courier, monospace;
    }
    .font-comic {
      font-family: "Comic Sans MS", cursive, sans-serif;
    }
    .font-roboto {
      font-family: "Roboto", sans-serif;
    }
    .font-times {
      font-family: "Times New Roman", Times, serif;
    }
    .font-verdana {
      font-family: Verdana, sans-serif;
    }
    .font-trebuchet {
      font-family: "Trebuchet MS", Helvetica, sans-serif;
    }
    .font-lucida {
      font-family: "Lucida Sans Unicode", "Lucida Grande", sans-serif;
    }
    .font-garamond {
      font-family: Garamond, serif;
    }

    /* ----------------------------------------
       4) Message Animation
       ---------------------------------------- */
    @keyframes message-enter {
      0% {
        transform: scale(0.8);
        opacity: 0;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }
    .message-enter {
      animation: message-enter 0.3s ease forwards;
    }

    /* ----------------------------------------
       5) DM Section
       ---------------------------------------- */
    #dmSection {
      margin-top: 20px;
      border-top: 1px solid #ccc;
      padding-top: 10px;
    }
    #dmMessages {
      list-style-type: none;
      padding: 0;
      max-height: 200px;
      overflow-y: auto;
      margin-bottom: 10px;
      border: 1px solid #ddd;
    }
    #dmMessages li {
      padding: 8px;
      border-bottom: 1px solid #eee;
      margin: 0 4px;
    }
    .dm-controls {
      display: flex;
      gap: 5px;
    }

    /* ----------------------------------------
       6) Group DM Section
       ---------------------------------------- */
    #groupDMSection {
      margin-top: 20px;
      border-top: 1px solid #ccc;
      padding-top: 10px;
    }
    #groupDMMessages {
      list-style-type: none;
      padding: 0;
      max-height: 200px;
      overflow-y: auto;
      margin-bottom: 10px;
      border: 1px solid #ddd;
    }
    #groupDMMessages li {
      padding: 8px;
      border-bottom: 1px solid #eee;
      margin: 0 4px;
    }
    .groupdm-controls {
      display: flex;
      gap: 5px;
    }

    /* ----------------------------------------
       7) Changelog Overlay
       (Always shows on page load)
       ---------------------------------------- */
    #changelogOverlay {
      position: fixed;
      top: 0; 
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      display: none; 
      justify-content: center;
      align-items: center;
      z-index: 9999; 
    }
    #changelogModal {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      max-width: 400px;
      width: 90%;
      color: #000;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    #changelogModal h2 {
      margin-top: 0;
    }
    #changelogModal ul {
      margin: 10px 0;
      padding-left: 20px;
    }
    #changelogModal button {
      margin-top: 10px;
    }

  </style>
</head>
<body>

  <!-- ===============================
       CHANGELOG POPUP (ALWAYS SHOWS)
       =============================== -->
  <div id="changelogOverlay">
    <div id="changelogModal">
      <h2>Changelog (v1.0.0)</h2>
      <ul>
        <li>Changelog popup always shows when you refresh or open a new tab.</li>
        <li>Settings can only be accessed from main screen.</li>
        <li>Removed highlight on your own messages.</li>
        <li>Chat textareas have no extra whitespace. SHIFT+ENTER for new lines.</li>
      </ul>
      <button onclick="closeChangelog()">Close</button>
    </div>
  </div>

  <!-- ===============================
       1) LOGIN SCREEN (loginDiv)
       =============================== -->
  <div id="loginDiv">
    <h2>Enter Chat</h2>
    <p>Anonymous / Temporary Name:</p>
    <input type="text" id="anonymousInput" class="username-input" placeholder="Anonymous Name" />
    <button onclick="startChatting()" class="enter-chat-btn">Start Chatting</button>

    <hr />
    <!-- Account Management (Username + Password) -->
    <h3>Account</h3>
    <div id="notLoggedInUI">
      <input type="text" id="accNameInput" placeholder="Desired username" style="width:100%; margin-bottom:5px;" />
      <input type="text" id="accPassInput" placeholder="Password" style="width:100%; margin-bottom:5px;" />
      <button onclick="createOrLoginAccount()">Create/Login Account</button>
    </div>

    <div id="loggedInUI" style="display:none;">
      <p>Logged in as: <span id="loggedInName"></span></p>
      <input type="text" id="renameInput" placeholder="New username" style="width:100%; margin-bottom:5px;" />
      <button onclick="renameAccount()">Rename Account</button>
      <br /><br />
      <button onclick="logOutAccount()">Log Out</button>
    </div>

    <hr />
    <!-- Settings button is only here, in the main screen -->
    <button onclick="showSettingsFromLogin()">Settings</button>
  </div>

  <!-- ================================
       2) CHAT SCREEN (chatDiv)
       ================================ -->
  <div id="chatDiv">
    <h2>Chat Room</h2>

    <!-- A) Messages + "Who is typing" indicator -->
    <ul id="messages"></ul>
    <div id="typingStatus"></div>

    <div class="chat-controls">
      <!-- Single-line <textarea> => no whitespace -->
      <textarea id="messageInput" placeholder="Type a message (SHIFT+ENTER for new line)"></textarea>
      <button onclick="sendMessage()">Send</button>
      <button onclick="clearChat()">Clear Chat</button>
    </div>

    <!-- 2B) Direct Messages Section -->
    <div id="dmSection">
      <h3>Direct Messages</h3>
      <div id="dmLoginWarning" style="color:red; display:none;">
        You must be logged in to use DMs.
      </div>
      <div id="dmUI" style="display:none;">
        <p>Type a single username to DM:</p>
        <input type="text" id="dmTargetInput" placeholder="username to DM" style="width:100%; margin-bottom:5px;" />
        <button onclick="openDM()">Open DM</button>

        <div id="dmConversation" style="margin-top:10px; display:none;">
          <ul id="dmMessages"></ul>
          <div class="dm-controls">
            <textarea id="dmMessageInput" placeholder="Type a direct message (SHIFT+ENTER for new line)"></textarea>
            <button onclick="sendDM()">Send DM</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 2C) Group DM Section -->
    <div id="groupDMSection">
      <h3>Group DMs</h3>
      <div id="groupLoginWarning" style="color:red; display:none;">
        You must be logged in to create or join Group DMs.
      </div>
      <div id="groupDMUI" style="display:none;">
        <button onclick="showGroupDMSetup()">Start Group DM</button>
        <div id="groupDMSetup" style="display:none; margin:10px 0;">
          <p>Type one or more usernames, separated by commas (e.g. "nightime, bobblyionized, chuckwee")</p>
          <input type="text" id="groupDMParticipantsInput" placeholder="User1, User2, ..." style="width:100%; margin-bottom:5px;" />
          <button onclick="createGroupDM()">Create Group DM</button>
        </div>
        <div id="activeGroupDM" style="display:none; margin-top:10px;">
          <p>Group Key: <span id="groupDMKeyDisplay"></span></p>
          <ul id="groupDMMessages"></ul>
          <div class="groupdm-controls">
            <textarea id="groupDMMessageInput" placeholder="Type a group message (SHIFT+ENTER for new line)"></textarea>
            <button onclick="sendGroupDM()">Send</button>
          </div>
          <br>
          <button onclick="showAddPeopleUI()">Add People</button>
          <div id="addPeopleUI" style="display:none; margin:10px 0;">
            <p>Type additional usernames, separated by commas:</p>
            <input type="text" id="addGroupDMParticipantsInput" placeholder="UserX, UserY, ..." style="width:100%; margin-bottom:5px;" />
            <button onclick="addMorePeople()">Add Selected People</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 2D) Button to Return to Main Screen -->
    <div style="margin-top:20px; text-align:center;">
      <button onclick="returnToLogin()">Return to Main Screen</button>
    </div>
  </div>

  <!-- ================================
       3) SETTINGS SCREEN (settingsDiv)
       ================================ -->
  <div id="settingsDiv">
    <h2>Settings</h2>
    <label>
      <input type="checkbox" id="themeToggle" onchange="toggleDarkMode()" />
      Dark Mode
    </label>
    <br><br>

    <label for="guiSizeRange">GUI Size</label>
    <input type="range" id="guiSizeRange" min="0.5" max="2.0" step="0.1" value="1.0" onchange="updateGuiSize()" />
    <p id="guiSizeValue"></p>

    <label for="fontSelect">Choose Font:</label>
    <select id="fontSelect" onchange="updateFont()">
      <option value="font-arial">Arial</option>
      <option value="font-georgia">Georgia</option>
      <option value="font-courier">Courier New</option>
      <option value="font-comic">Comic Sans MS</option>
      <option value="font-roboto">Roboto</option>
      <option value="font-times">Times New Roman</option>
      <option value="font-verdana">Verdana</option>
      <option value="font-trebuchet">Trebuchet MS</option>
      <option value="font-lucida">Lucida Sans Unicode</option>
      <option value="font-garamond">Garamond</option>
    </select>
    <br><br>

    <button onclick="goBack()">Back</button>
  </div>

  <!-- ---------------------------------
       Firebase SDK (Compat versions)
       --------------------------------->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>

  <!-- SHA-256 library for hashing passwords -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>

  <script>
    /* =====================================================
       1) Firebase Configuration & Initialization
       ===================================================== */
    const firebaseConfig = {
      apiKey: "AIzaSyBkm5Lf3PaghllqcatG_FymhTm_x7mGa28",
      authDomain: "yaproom-14cfe.firebaseapp.com",
      databaseURL: "https://yaproom-14cfe-default-rtdb.firebaseio.com",
      projectId: "yaproom-14cfe",
      storageBucket: "yaproom-14cfe.firebasestorage.app",
      messagingSenderId: "5332542311",
      appId: "1:5332542311:web:f1a1ab2fb81bf62b0b45c2"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    /* =====================================================
       2) Global Variables
       ===================================================== */
    let lastMessageTime = 0;
    const RATE_LIMIT_MS = 2000; // 2-second limit
    const badWords = ["shit","fuck","bitch"]; // Expand as needed

    let currentUsername = null;
    let currentPassHash = null;
    let currentDMPath = null;
    let dmListener = null;
    let currentGroupDMKey = null;
    let groupDMListener = null;
    let typingTimeout = null;

    /* =====================================================
       3) On Page Load: Always show Changelog
       ===================================================== */
    window.onload = function() {
      // Always show the overlay on every refresh or new tab
      document.getElementById("changelogOverlay").style.display = "flex";

      // A) Dark Mode
      const darkModeEnabled = localStorage.getItem("darkModeEnabled") === "true";
      if (darkModeEnabled) document.body.classList.add("dark-mode");
      document.getElementById("themeToggle").checked = darkModeEnabled;

      // B) GUI Size
      const savedScale = localStorage.getItem("uiScale");
      if (savedScale) {
        document.documentElement.style.fontSize = (16 * savedScale) + "px";
        document.getElementById("guiSizeRange").value = savedScale;
      }
      updateGuiSizeDisplay();

      // C) Font
      const savedFont = localStorage.getItem("selectedFont") || "font-arial";
      document.body.classList.add(savedFont);
      document.getElementById("fontSelect").value = savedFont;

      // D) Account
      currentUsername = localStorage.getItem("acc_username");
      currentPassHash = localStorage.getItem("acc_passHash");
      updateAccountUI();

      // E) Listen for public chat
      db.ref("messages").on("child_added", (snapshot) => {
        const msg = snapshot.val();
        displayMessage(msg.user, msg.text, msg.isAccount);
      });

      // F) Listen for "typing" updates
      db.ref("typing").on("value", (snap) => {
        const typingObj = snap.val() || {};
        showTypingStatus(typingObj);
      });

      // SHIFT+ENTER for main chat
      const msgInput = document.getElementById("messageInput");
      msgInput.addEventListener("keydown", function(e) {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
      msgInput.addEventListener("input", autoResize);

      // SHIFT+ENTER for DM
      const dmInput = document.getElementById("dmMessageInput");
      dmInput.addEventListener("keydown", function(e) {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendDM();
        }
      });
      dmInput.addEventListener("input", autoResize);

      // SHIFT+ENTER for Group DM
      const groupInput = document.getElementById("groupDMMessageInput");
      groupInput.addEventListener("keydown", function(e) {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendGroupDM();
        }
      });
      groupInput.addEventListener("input", autoResize);
    };

    /* Close the changelog overlay each time */
    function closeChangelog() {
      document.getElementById("changelogOverlay").style.display = "none";
    }

    /* Auto-resize logic for textareas */
    function autoResize(event) {
      const textarea = event.target;
      textarea.style.height = "auto";
      textarea.style.height = (textarea.scrollHeight) + "px";
    }

    /* =====================================================
       4) Account Creation / Login
       ===================================================== */
    async function createOrLoginAccount() {
      const desiredName = document.getElementById("accNameInput").value.trim().toLowerCase();
      const desiredPass = document.getElementById("accPassInput").value.trim();
      if (!desiredName || !desiredPass) {
        alert("Please provide both a username and a password.");
        return;
      }
      const passHash = sha256(desiredPass);

      try {
        const snap = await db.ref("accounts/" + desiredName).once("value");
        if (!snap.exists()) {
          // Create new account
          await db.ref("accounts/" + desiredName).set({
            passwordHash: passHash,
            createdAt: Date.now()
          });
          alert("Account created! Logged in as: " + desiredName);
        } else {
          // Existing account, verify password
          const data = snap.val();
          if (data.passwordHash !== passHash) {
            alert("Incorrect password or name is taken by someone else.");
            return;
          }
          alert("Logged in successfully as: " + desiredName);
        }
        currentUsername = desiredName;
        currentPassHash = passHash;
        localStorage.setItem("acc_username", currentUsername);
        localStorage.setItem("acc_passHash", currentPassHash);
        updateAccountUI();
      } catch (err) {
        alert("Error creating/logging in: " + err);
      }
    }

    function updateAccountUI() {
      const notLoggedInUI = document.getElementById("notLoggedInUI");
      const loggedInUI = document.getElementById("loggedInUI");
      const loggedInName = document.getElementById("loggedInName");
      if (currentUsername && currentPassHash) {
        notLoggedInUI.style.display = "none";
        loggedInUI.style.display = "block";
        loggedInName.textContent = currentUsername;
      } else {
        notLoggedInUI.style.display = "block";
        loggedInUI.style.display = "none";
      }
      updateDMUI();
      updateGroupDMUI();
    }

    async function logOutAccount() {
      if (currentUsername) {
        db.ref("typing/" + currentUsername).remove();
      }
      localStorage.removeItem("acc_username");
      localStorage.removeItem("acc_passHash");
      currentUsername = null;
      currentPassHash = null;
      alert("Logged out.");
      updateAccountUI();
    }

    /* =====================================================
       5) Rename Account
       ===================================================== */
    async function renameAccount() {
      if (!currentUsername || !currentPassHash) {
        alert("You are not logged in, can't rename.");
        return;
      }
      const newName = document.getElementById("renameInput").value.trim().toLowerCase();
      if (!newName) {
        alert("Enter a new username.");
        return;
      }
      // Check if taken
      const snap = await db.ref("accounts/" + newName).once("value");
      if (snap.exists()) {
        alert("That username is taken.");
        return;
      }
      try {
        // remove old
        await db.ref("accounts/" + currentUsername).remove();
        // create new
        await db.ref("accounts/" + newName).set({
          passwordHash: currentPassHash,
          createdAt: Date.now()
        });
        // remove old typing
        db.ref("typing/" + currentUsername).remove();

        currentUsername = newName;
        localStorage.setItem("acc_username", currentUsername);
        alert("Renamed to " + newName);
        updateAccountUI();
      } catch (err) {
        alert("Error renaming: " + err);
      }
    }

    /* =====================================================
       6) Starting the Chat
       ===================================================== */
    function startChatting() {
      if (!currentUsername) {
        const anonName = document.getElementById("anonymousInput").value.trim();
        if (!anonName) {
          alert("Please enter a name or create an account.");
          return;
        }
        currentUsername = anonName;
      }
      document.getElementById("loginDiv").style.display = "none";
      document.getElementById("chatDiv").style.display = "block";
      updateDMUI();
      updateGroupDMUI();
    }

    /* =====================================================
       7) Public Chat
       ===================================================== */
    function filterBadWords(text) {
      const badWordsLower = badWords.map(word => word.toLowerCase());
      let filtered = text;
      badWordsLower.forEach(word => {
        const regex = new RegExp("\\b" + word + "\\b", "gi");
        filtered = filtered.replace(regex, "****");
      });
      return filtered;
    }

    function sendMessage() {
      const currentTime = Date.now();
      if (currentTime - lastMessageTime < RATE_LIMIT_MS) {
        const secLeft = Math.ceil((RATE_LIMIT_MS - (currentTime - lastMessageTime)) / 1000);
        alert(`Wait ${secLeft} second(s).`);
        return;
      }
      const inp = document.getElementById("messageInput");
      let text = inp.value.trim();
      if (!text) return;
      text = filterBadWords(text);

      let finalName = currentUsername;
      const isAccount = (finalName != null && currentPassHash != null);

      if (!finalName) {
        finalName = "Unknown";
      }

      const msgData = {
        user: finalName,
        text: text,
        isAccount: isAccount,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      };
      db.ref("messages").push(msgData);
      inp.value = "";
      inp.style.height = "40px";
      lastMessageTime = currentTime;

      if (currentUsername) {
        db.ref("typing/" + currentUsername).remove();
      }
    }

    function displayMessage(user, text, isAccount) {
      const ul = document.getElementById("messages");
      const li = document.createElement("li");
      li.classList.add("message-enter");

      // color code name
      const userClass = isAccount ? "account-user" : "anonymous-user";
      li.innerHTML = `<span class="${userClass}">${user}</span>: ${text}`;

      ul.appendChild(li);
      ul.scrollTop = ul.scrollHeight;
    }

    function clearChat() {
      const confirmClear = confirm("Are you sure you want to clear the entire public chat?");
      if (!confirmClear) return;
      db.ref("messages").remove();
      document.getElementById("messages").innerHTML = "";
    }

    /* =====================================================
       8) Typing Indicators (Main Chat)
       ===================================================== */
    function handleTyping() {
      if (!currentUsername) return;
      db.ref("typing/" + currentUsername).set(true);
      if (typingTimeout) clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        db.ref("typing/" + currentUsername).remove();
      }, 3000);
    }

    function showTypingStatus(typingObj) {
      const keys = Object.keys(typingObj).filter((u) => u !== currentUsername);
      const typingDiv = document.getElementById("typingStatus");
      if (keys.length === 0) {
        typingDiv.textContent = "";
      } else if (keys.length === 1) {
        typingDiv.textContent = `${keys[0]} is typing...`;
      } else {
        typingDiv.textContent = `${keys.join(", ")} are typing...`;
      }
    }

    /* =====================================================
       9) Single DM
       ===================================================== */
    function updateDMUI() {
      const warn = document.getElementById("dmLoginWarning");
      const ui = document.getElementById("dmUI");
      if (currentUsername && currentPassHash) {
        warn.style.display = "none";
        ui.style.display = "block";
      } else {
        warn.style.display = "block";
        ui.style.display = "none";
      }
    }

    function openDM() {
      const typedName = document.getElementById("dmTargetInput").value.trim().toLowerCase();
      if (!typedName) {
        alert("Please type a username to DM.");
        return;
      }
      if (!currentUsername || !currentPassHash) {
        alert("You must be logged in to DM.");
        return;
      }
      const userA = currentUsername.toLowerCase();
      const userB = typedName;
      const dmKey = (userA < userB) ? (userA + "_" + userB) : (userB + "_" + userA);
      currentDMPath = "dms/" + dmKey;

      document.getElementById("dmMessages").innerHTML = "";
      document.getElementById("dmConversation").style.display = "block";

      if (dmListener) {
        db.ref(currentDMPath).off("child_added", dmListener);
      }
      dmListener = db.ref(currentDMPath).on("child_added", (snap) => {
        const val = snap.val();
        displayDMMessage(val.user, val.text);
      });
    }

    function displayDMMessage(sender, text) {
      const ul = document.getElementById("dmMessages");
      const li = document.createElement("li");
      li.textContent = `${sender}: ${text}`;
      li.classList.add("message-enter");
      ul.appendChild(li);
      ul.scrollTop = ul.scrollHeight;
    }

    function sendDM() {
      if (!currentDMPath) {
        alert("No DM open. Type a username and 'Open DM' first.");
        return;
      }
      const inp = document.getElementById("dmMessageInput");
      let text = inp.value.trim();
      if (!text) return;
      text = filterBadWords(text);
      const finalName = currentUsername || "Unknown";
      const msgData = {
        user: finalName,
        text: text,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      };
      db.ref(currentDMPath).push(msgData);
      inp.value = "";
      inp.style.height = "40px"; 
    }

    /* =====================================================
       10) Group DM
       ===================================================== */
    function updateGroupDMUI() {
      const warn = document.getElementById("groupLoginWarning");
      const ui = document.getElementById("groupDMUI");
      if (currentUsername && currentPassHash) {
        warn.style.display = "none";
        ui.style.display = "block";
      } else {
        warn.style.display = "block";
        ui.style.display = "none";
      }
    }

    function showGroupDMSetup() {
      document.getElementById("groupDMSetup").style.display = "block";
    }

    async function createGroupDM() {
      const typed = document.getElementById("groupDMParticipantsInput").value.trim();
      if (!typed) {
        alert("Type at least one user (plus yourself).");
        return;
      }
      let participants = typed.split(",").map(s => s.trim().toLowerCase()).filter(s => s);
      if (currentUsername && !participants.includes(currentUsername)) {
        participants.push(currentUsername);
      }
      if (participants.length < 2) {
        alert("Need at least 2 total participants (you + 1).");
        return;
      }

      const groupKey = "group_" + Date.now();
      currentGroupDMKey = groupKey;
      const groupObj = {
        participants: participants,
        createdAt: Date.now(),
        messages: {
          dummy: { system: "Group created" }
        }
      };
      try {
        await db.ref("groupDms/" + groupKey).set(groupObj);
        alert("Group DM created: " + groupKey);
        openGroupDM(groupKey);
      } catch (err) {
        alert("Error creating group DM: " + err);
      }
    }

    function openGroupDM(gKey) {
      if (groupDMListener) {
        db.ref("groupDms/" + currentGroupDMKey + "/messages").off("child_added", groupDMListener);
      }
      currentGroupDMKey = gKey;
      document.getElementById("groupDMMessages").innerHTML = "";
      document.getElementById("groupDMKeyDisplay").textContent = gKey;
      document.getElementById("activeGroupDM").style.display = "block";
      document.getElementById("groupDMSetup").style.display = "none";

      groupDMListener = db.ref("groupDms/" + gKey + "/messages").on("child_added", (snap) => {
        const val = snap.val();
        if (val.user && val.text) {
          displayGroupDMMessage(val.user, val.text);
        } else if (val.system) {
          displayGroupDMMessage("System", val.system);
        }
      });
    }

    function displayGroupDMMessage(sender, text) {
      const ul = document.getElementById("groupDMMessages");
      const li = document.createElement("li");
      li.textContent = `${sender}: ${text}`;
      li.classList.add("message-enter");
      ul.appendChild(li);
      ul.scrollTop = ul.scrollHeight;
    }

    function sendGroupDM() {
      if (!currentGroupDMKey) {
        alert("No group DM open yet.");
        return;
      }
      const currentTime = Date.now();
      if (currentTime - lastMessageTime < RATE_LIMIT_MS) {
        const secLeft = Math.ceil((RATE_LIMIT_MS - (currentTime - lastMessageTime)) / 1000);
        alert(`Wait ${secLeft} second(s).`);
        return;
      }
      const inp = document.getElementById("groupDMMessageInput");
      let text = inp.value.trim();
      if (!text) return;
      text = filterBadWords(text);

      const finalName = currentUsername || "Unknown";
      const msgData = {
        user: finalName,
        text: text,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      };
      db.ref("groupDms/" + currentGroupDMKey + "/messages").push(msgData);
      inp.value = "";
      inp.style.height = "40px";
      lastMessageTime = currentTime;
    }

    function showAddPeopleUI() {
      document.getElementById("addPeopleUI").style.display = "block";
    }

    async function addMorePeople() {
      if (!currentGroupDMKey) {
        alert("No group DM open to add people.");
        return;
      }
      const typed = document.getElementById("addGroupDMParticipantsInput").value.trim();
      if (!typed) {
        alert("No participants typed.");
        return;
      }
      let newNames = typed.split(",").map(s => s.trim().toLowerCase()).filter(s => s);
      if (newNames.length === 0) {
        alert("No valid usernames found.");
        return;
      }
      const snap = await db.ref("groupDms/" + currentGroupDMKey + "/participants").once("value");
      const oldList = snap.val() || [];
      const merged = Array.from(new Set(oldList.concat(newNames)));
      try {
        await db.ref("groupDms/" + currentGroupDMKey + "/participants").set(merged);
        const text = newNames.join(", ") + " added to the group.";
        db.ref("groupDms/" + currentGroupDMKey + "/messages").push({ system: text });
        alert("Added: " + newNames.join(", "));
      } catch (err) {
        alert("Error adding participants: " + err);
      }
      document.getElementById("addPeopleUI").style.display = "none";
    }

    /* =====================================================
       11) Return to Main Screen
       ===================================================== */
    function returnToLogin() {
      document.getElementById("chatDiv").style.display = "none";
      document.getElementById("loginDiv").style.display = "block";
    }

    /* =====================================================
       12) Settings Navigation
       ===================================================== */
    function showSettingsFromLogin() {
      document.getElementById("loginDiv").style.display = "none";
      document.getElementById("settingsDiv").style.display = "block";
    }

    function goBack() {
      // Always go back to the main screen (loginDiv)
      document.getElementById("settingsDiv").style.display = "none";
      document.getElementById("loginDiv").style.display = "block";
    }

    /* =====================================================
       13) Dark Mode Toggle
       ===================================================== */
    function toggleDarkMode() {
      document.body.classList.toggle("dark-mode");
      const isDark = document.body.classList.contains("dark-mode");
      localStorage.setItem("darkModeEnabled", isDark);
    }

    /* =====================================================
       14) GUI Size
       ===================================================== */
    function updateGuiSize() {
      const scale = document.getElementById("guiSizeRange").value;
      document.documentElement.style.fontSize = (16 * scale) + "px";
      localStorage.setItem("uiScale", scale);
      updateGuiSizeDisplay();
    }

    function updateGuiSizeDisplay() {
      const val = document.getElementById("guiSizeRange").value;
      document.getElementById("guiSizeValue").textContent = `Current Scale: ${val}x`;
    }

    /* =====================================================
       15) Custom Font
       ===================================================== */
    function updateFont() {
      document.body.classList.remove(
        "font-arial",
        "font-georgia",
        "font-courier",
        "font-comic",
        "font-roboto",
        "font-times",
        "font-verdana",
        "font-trebuchet",
        "font-lucida",
        "font-garamond"
      );
      const selectedFont = document.getElementById("fontSelect").value;
      document.body.classList.add(selectedFont);
      localStorage.setItem("selectedFont", selectedFont);
    }
  </script>
</body>
</html>
